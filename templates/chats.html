{% extends "homepage.html" %}

{% block title %}
    Chat to collect your food items here! : 
{% endblock %}

{% block body %}
    <!-- Main container -->
    <div class="container">
      <!-- msg-header section starts -->
      <div class="msg-header">
        <div class="container1">
          <img2 src="static\default-profile-picture-male-icon.png" class="msgimg" />
          <div class="active">
            <p>NourishNeighbour</p>
          </div>
        </div>
      </div>
      <!-- msg-header section ends -->

      <!-- Chat inbox  -->
      <div class="chat-page">
        <div class="msg-inbox">
          <div class="chats">
            <!-- Message container -->
            <div class="msg-page">
              <!-- Incoming messages -->
              <!-- Your incoming message code goes here -->

              <!-- Outgoing messages -->
              <!-- Your outgoing message code goes here -->
            </div>
          </div>

          <!-- msg-bottom section -->
          <div class="msg-bottom">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                placeholder="Write message..."
                id="message-input" 
              />

              <!-- Hidden input for chatroom_id -->
              <input
                type="hidden"
                id="chatroom-id"
                value="{{ chatroom_id }}"
              />

              <span class="input-group-text send-icon" id="send-button">
                <i class="bi bi-send"></i> Send <!-- Added id attribute -->
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Function to fetch messages
        function fetchMessages() {
            var chatroomId = $("#chatroom-id").val();
            $.ajax({
                type: "GET",
                url: "/fetch_message",
                data: { chatroom_id: chatroomId },
                success: function(response) {
                    response.forEach(function(message) {
                        $(".msg-page").append('<p>' + message.message + '</p>');
                    });
                },
                error: function(xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        }

        // Fetch messages when the page loads
        fetchMessages();

        // When the send button is clicked
        $("#send-button").click(function() {
            var messageContent = $("#message-input").val();
            var chatroomId = $("#chatroom-id").val();

            // Send an AJAX request to the Flask route to send the message
            $.ajax({
                type: "POST",
                url: "/send_message",
                data: { message: messageContent, chatroom_id: chatroomId },
                success: function(response) {
                    // Clear input field and blur it after sending message
                    $("#message-input").val("").blur();
                    // Optionally, fetch messages again to update the chat interface
                    fetchMessages();
                },
                error: function(xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        });
    });
</script>
{% endblock %}
