{% extends "homepage.html" %}

{% block title %}
Nourished
{% endblock %}

{% block body %}
<h1>Listing Filter</h1>

<form method="POST" action="/nourished">
    <label for="allergies">Allergies/ Dietary Restrictions (if any):</label>
    <input type="text" name="allergy" id="allergy">
    <input type="submit" value="Submit">
</form>

<label for="category-filter">Select a category:</label>
<select id="category-filter">
    <option value="all" selected>All Categories</option>
    <option value="Vegetables">Vegetables</option>
    <option value="Fruits">Fruits</option>
    <option value="Dairy">Dairy Products</option>
    <option value="Eggs">Eggs</option>
    <option value="Oil">Oil</option>
    <option value="Snacks">Snacks And Crackers</option>
    <option value="Canned">Canned Food</option>
    <option value="Drinks">Drinks and beverages</option>
    <option value="Dried">Dried Food</option>
    <option value="Noodles">Noodles</option>
    <option value="Rice"> Rice </option>
    <option value="Cereal"> Cereal </option>
    <option value="Bread"> Bread </option>
    <option value="Others">Others</option>
    <!-- Add more options for each category in your database -->
</select>

<div id="filtered-content">
    <!-- Filtered content will be displayed here -->
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Define the URL for the items page
    var itemsUrl = "items.html";

    $(document).ready(function () {
        // Trigger the filterItems function immediately upon page load
        filterItems();

        // Attach an event listener to the category filter select element
        $('#category-filter').on('change', function () {
            filterItems();
        });

        // Attach an event listener to the allergy form submission
        $('form').submit(function (e) {
            e.preventDefault();
            filterItems();
        });

        // Attach a click event listener to the item titles
        $(document).on('click', '.item-title', function () {
            // Get the item ID (document ID) from the parent element's data-id attribute
            var itemId = $(this).parent().data('id');
            // Redirect to items.html with the item ID
            window.location.href = itemsUrl + '?id=' + itemId;
        });

        function filterItems() {
            var selectedCategory = $('#category-filter').val(); // Get the selected category

            // Make an AJAX request to your Flask endpoint to fetch filtered data
            $.ajax({
                url: '/api/getItems?category=' + selectedCategory,
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    // Clear the filtered content
                    $('#filtered-content').empty();

                    // Append the filtered data to the content container
                    // Append the filtered data to the content container
                    $.each(data, function (index, item) {
                        // Customize this part to display your item data as you like
                        var itemHtml = '<div class="item" data-id="' + item.id + '">' + // Use document ID as data-id
                            '<a href="' + itemsUrl + '?id=' + item.id + '">' + '<h2 class="item-title">' + item.title + '</h2>' + '</a>' +
                            '<p>Category: ' + item.category + '</p>' +
                            '<p>Other categories (if specified): ' + item.other + '</p>' +
                            '<p>Ingredients: ' + item.ingredients + '</p>' +
                            '<p>Quantity: ' + item.quantity + '</p>' +
                            '<p>Expiry date: ' + item.expiry_date + '</p>' +
                            '<p>Location of nourisher: ' + item.location + '</p>' +
                            '<img src="' + item.image_url + '" alt="' + item.title + '">' +
                            // Add more item details as needed
                            '</div>';
                        $('#filtered-content').append(itemHtml);
                    });

                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        }
    });
</script>

{% endblock %}